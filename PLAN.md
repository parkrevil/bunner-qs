# bunner_qs 계획 (표준 우선)

JavaScript `qs`와의 기능 동등성 대신 RFC 및 WHATWG 표준에 충실한 쿼리 스트링 유틸리티를 Rust로 구현한다.

## 1. 적용 표준
- **RFC 3986** – URI 문법과 쿼리 컴포넌트의 퍼센트 인코딩 규칙.
- **RFC 3987** – IRI 규격으로, 유니코드 문자의 퍼센트 인코딩 해석을 보완한다.
- **WHATWG URL Standard (Living)** – 현대 URL 파서와 `application/x-www-form-urlencoded` 인코딩 규칙의 근거.
- **HTML Standard §4.10.22.6** – 폼 전송 시 plus 기호(`+`)를 공백으로 처리하는 알고리즘을 정의한다.

위 문서를 기준으로 허용 문법과 인코딩을 명시적으로 결정하며, 다른 기능은 배제한다.

## 2. 목표
- 표준에 맞는 **예측 가능한 파싱/직렬화** 동작 제공.
- 사용자가 쉽게 쓸 수 있는 **간결한 Rust API** 노출.
- **Round-trip 안정성** 확보: `stringify(parse(input))`과 `parse(stringify(value))`가 동일한 결과를 낼 것.
- 구현을 작고 검증 가능하게 유지하여 **정확성**을 우선시한다.

## 3. 범위
### 파싱
- RFC 3986 규칙에 따라 퍼센트 인코딩을 해석하고, 잘못된 `%` 시퀀스는 에러 처리한다.
- HTML 폼 호환 모드일 때만 `+`를 공백으로 간주하고, 기본 모드에서는 문자 그대로 유지한다.
- 키는 문자열 그대로 보존하고, 동일 키가 반복되면 순서를 유지한 `Vec<String>`으로 누적한다.
- 기본적으로 중첩 구조를 추론하지 않는다(브래킷/도트 표기 해석 없음).
- 옵션화된 **`max_params`**, **`max_length`**, **`max_depth`**로 입력 크기와 깊이를 제한하고, 필요 시 중복 키 허용 여부를 조절한다.

### 문자열화
- UTF-8 문자열을 RFC 3986 규칙으로 퍼센트 인코딩한다.
- 공백은 기본적으로 `%20`, 폼 모드에서는 `+`로 인코딩한다.
- 다중 값은 반복된 키로 출력하며, 배열 포맷 변형은 제공하지 않는다.
- 기본적으로 입력 순서를 유지하고, 차후 정렬 훅은 선택 사항으로 제공한다.
- 필요에 따라 `?` 접두사를 붙일 수 있다.

### 비범위
- 사용자 정의 인코더/디코더, 비 UTF-8 문자셋, RFC 1738 방식 기본 적용(+ → 공백) 등은 지원하지 않는다.
- 브래킷/도트 표기를 구조화된 객체로 변환하지 않는다.
- Symbols나 함수 등 비 문자열 값을 처리하지 않는다.

## 4. 아키텍처 스냅샷
```
src/
  lib.rs            // 공개 API
  parse.rs          // 파서 구현
  stringify.rs      // 직렬화 구현
  options.rs        // 옵션 구조체와 기본값
  error.rs          // 공통 에러 타입
  value.rs          // 구조화된 값 표현 (IndexMap + 다중 값)
  util.rs           // 퍼센트 인코딩/검증 유틸리티
tests/
  parse.rs
  stringify.rs
  roundtrip.rs (선택)
```

## 5. 로드맵
### Phase 1 – 핵심 표준 준수
1. `ParseOptions` / `StringifyOptions` 정의: `space_as_plus`, `max_params`, `max_length`, `max_depth`, `allow_duplicates`, `add_query_prefix`.
2. UTF-8 유효성을 검사하는 퍼센트 디코더 구현.
3. 입력을 `IndexMap<String, Vec<String>>`으로 파싱.
4. 동일 구조에서 문자열화.
5. 잘못된 `%` 시퀀스, `+` 처리, 중복, 제한 초과 케이스를 포함한 단위 테스트 작성.

### Phase 2 – 편의 기능
1. 단일 값 맵(`<String, String>`)으로의 변환/복원 도우미 제공.
2. 선택적 정렬 콜백(`FnMut(&str, &str) -> Ordering`).
3. 옵션 빌더 패턴 도입으로 안전한 설정 흐름 제공.
4. 폼 모드 vs 순수 RFC 모드 사용 설명 문서화.

### Phase 3 – 확장 프로필 (Feature Flag)
- `form-mode`: 기본 `space_as_plus = true`로 설정하고 폼 데이터 헬퍼 추가.
- `serde` 연계: 구조체 변환 편의성 제공.
- `query-types`: 정수/불리언 변환을 위한 타입 안전 도우미.

## 6. 테스트 전략
- RFC 예제 기반의 인코딩/디코딩 단위 테스트.
- HTML 폼 인코딩(공백, 빈 값, plus 처리) 케이스.
- 무작위 ASCII/유니코드 문자열에 대한 round-trip property 테스트.
- 길이/파라미터/깊이 제한 위반 시 에러 발생 확인.

## 7. 문서 산출물
- README에 표준 준수 설명과 사용 예제 포함.
- URL 쿼리 파싱, 신규 쿼리 빌드, `space_as_plus` 토글 사례 제시.
- 다른 Rust 크레이트 및 JS `URLSearchParams`와의 비교 표 제공.

## 8. 명시적 제외 항목
- 중첩 객체 복원 없음 (`user[name]`은 문자열 키로 보존).
- 배열 포맷 변형(콤마, 브래킷 등) 미지원.
- 비 UTF-8 바이너리 값 처리 없음.
- 미정의 옵션 주입(`additional` 맵 등) 미지원.

## 9. 완료 기준
- Phase 1 요구 사항 구현 및 테스트 통과.
- 표준과 차이점을 설명하는 문서 공개.
- 에러 메시지가 지원 범위를 명확히 안내.
